

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="images/favicon.png" >

  <title>
    index.js - Documentation
  </title>

  <script src="scripts/prettify/prettify.js"></script>
  <script src="scripts/prettify/lang-css.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/elv-jsdoc.css">
  <link type="text/css" rel="stylesheet" href="styles/elv-prettify-jsdoc.css">
</head>

<body>
  <div class="layout-container">
    <nav class="nav-container">
      <div class="header">
        <a href="index.html">
          <img class="logo" src="images/logo-dark.png" />
        </a>
        <div class="title">
          Eluvio Media Wallet
        </div>
      </div>
      <div class="nav-content">
        <h3>Classes</h3><ul><li id="ElvWalletClient-nav">
          <div data-name="ElvWalletClient" class="class-link-container"><a class="class-link">ElvWalletClient</a></div><ul class='methods'><h4 class="methodGroupHeader">Constructor</h4><li data-type="method" id="ElvWalletClient-ElvWalletClient-nav"><a href="ElvWalletClient.html" class="method-link">ElvWalletClient</a></li><li data-type="method" id="ElvWalletClient-InitializeFrame-nav"><a href="ElvWalletClient.html#.InitializeFrame" class="method-link">InitializeFrame</a></li><li data-type="method" id="ElvWalletClient-InitializePopup-nav"><a href="ElvWalletClient.html#.InitializePopup" class="method-link">InitializePopup</a></li><h4 class="methodGroupHeader">Authorization</h4><li data-type="method" id="ElvWalletClient-SignIn-nav"><a href="ElvWalletClient.html#SignIn" class="method-link">SignIn</a></li><li data-type="method" id="ElvWalletClient-SignOut-nav"><a href="ElvWalletClient.html#SignOut" class="method-link">SignOut</a></li><h4 class="methodGroupHeader">Events</h4><li data-type="method" id="ElvWalletClient-AddEventListener-nav"><a href="ElvWalletClient.html#AddEventListener" class="method-link">AddEventListener</a></li><li data-type="method" id="ElvWalletClient-Events-nav"><a href="ElvWalletClient.html#Events" class="method-link">Events</a></li><li data-type="method" id="ElvWalletClient-RemoveEventListener-nav"><a href="ElvWalletClient.html#RemoveEventListener" class="method-link">RemoveEventListener</a></li><h4 class="methodGroupHeader">Navigation</h4><li data-type="method" id="ElvWalletClient-CurrentPath-nav"><a href="ElvWalletClient.html#CurrentPath" class="method-link">CurrentPath</a></li><li data-type="method" id="ElvWalletClient-Navigate-nav"><a href="ElvWalletClient.html#Navigate" class="method-link">Navigate</a></li><li data-type="method" id="ElvWalletClient-ToggleDarkMode-nav"><a href="ElvWalletClient.html#ToggleDarkMode" class="method-link">ToggleDarkMode</a></li><li data-type="method" id="ElvWalletClient-ToggleNavigation-nav"><a href="ElvWalletClient.html#ToggleNavigation" class="method-link">ToggleNavigation</a></li><li data-type="method" id="ElvWalletClient-ToggleSidePanelMode-nav"><a href="ElvWalletClient.html#ToggleSidePanelMode" class="method-link">ToggleSidePanelMode</a></li></ul></li></ul><h3>Modules</h3><ul><li id="ElvWalletClient_Methods-nav">
          <div data-name="ElvWalletClient/Methods" class="class-link-container"><a class="class-link">ElvWalletClient/Methods</a></div><ul class='methods'><li data-type="method" id="ElvWalletClient_Methods-ElvWalletClient/Methods-nav"><a href="module-ElvWalletClient_Methods.html" class="method-link">ElvWalletClient/Methods</a></li><h4 class="methodGroupHeader">Event</h4><li data-type="method" id="ElvWalletClient_Methods-EventMetadata-nav"><a href="module-ElvWalletClient_Methods.html#.EventMetadata" class="method-link">EventMetadata</a></li><h4 class="methodGroupHeader">Items</h4><li data-type="method" id="ElvWalletClient_Methods-Item-nav"><a href="module-ElvWalletClient_Methods.html#.Item" class="method-link">Item</a></li><li data-type="method" id="ElvWalletClient_Methods-ItemNames-nav"><a href="module-ElvWalletClient_Methods.html#.ItemNames" class="method-link">ItemNames</a></li><li data-type="method" id="ElvWalletClient_Methods-Items-nav"><a href="module-ElvWalletClient_Methods.html#.Items" class="method-link">Items</a></li><h4 class="methodGroupHeader">Listings</h4><li data-type="method" id="ElvWalletClient_Methods-EditListing-nav"><a href="module-ElvWalletClient_Methods.html#.EditListing" class="method-link">EditListing</a></li><li data-type="method" id="ElvWalletClient_Methods-Listing-nav"><a href="module-ElvWalletClient_Methods.html#.Listing" class="method-link">Listing</a></li><li data-type="method" id="ElvWalletClient_Methods-Listings-nav"><a href="module-ElvWalletClient_Methods.html#.Listings" class="method-link">Listings</a></li><li data-type="method" id="ElvWalletClient_Methods-ListItem-nav"><a href="module-ElvWalletClient_Methods.html#.ListItem" class="method-link">ListItem</a></li><li data-type="method" id="ElvWalletClient_Methods-RemoveListing-nav"><a href="module-ElvWalletClient_Methods.html#.RemoveListing" class="method-link">RemoveListing</a></li><li data-type="method" id="ElvWalletClient_Methods-UserListings-nav"><a href="module-ElvWalletClient_Methods.html#.UserListings" class="method-link">UserListings</a></li><h4 class="methodGroupHeader">Marketplace</h4><li data-type="method" id="ElvWalletClient_Methods-ClearMarketplaceFilters-nav"><a href="module-ElvWalletClient_Methods.html#.ClearMarketplaceFilters" class="method-link">ClearMarketplaceFilters</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplaceItem-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplaceItem" class="method-link">MarketplaceItem</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplaceItems-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplaceItems" class="method-link">MarketplaceItems</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplaceMetadata-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplaceMetadata" class="method-link">MarketplaceMetadata</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplaceStock-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplaceStock" class="method-link">MarketplaceStock</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplaceStorefront-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplaceStorefront" class="method-link">MarketplaceStorefront</a></li><li data-type="method" id="ElvWalletClient_Methods-SetMarketplace-nav"><a href="module-ElvWalletClient_Methods.html#.SetMarketplace" class="method-link">SetMarketplace</a></li><li data-type="method" id="ElvWalletClient_Methods-SetMarketplaceFilters-nav"><a href="module-ElvWalletClient_Methods.html#.SetMarketplaceFilters" class="method-link">SetMarketplaceFilters</a></li><h4 class="methodGroupHeader">Packs</h4><li data-type="method" id="ElvWalletClient_Methods-OpenPack-nav"><a href="module-ElvWalletClient_Methods.html#.OpenPack" class="method-link">OpenPack</a></li><li data-type="method" id="ElvWalletClient_Methods-PackOpenStatus-nav"><a href="module-ElvWalletClient_Methods.html#.PackOpenStatus" class="method-link">PackOpenStatus</a></li><h4 class="methodGroupHeader">Purchases</h4><li data-type="method" id="ElvWalletClient_Methods-ListingPurchase-nav"><a href="module-ElvWalletClient_Methods.html#.ListingPurchase" class="method-link">ListingPurchase</a></li><li data-type="method" id="ElvWalletClient_Methods-MarketplacePurchase-nav"><a href="module-ElvWalletClient_Methods.html#.MarketplacePurchase" class="method-link">MarketplacePurchase</a></li><li data-type="method" id="ElvWalletClient_Methods-PurchasePrice-nav"><a href="module-ElvWalletClient_Methods.html#.PurchasePrice" class="method-link">PurchasePrice</a></li><li data-type="method" id="ElvWalletClient_Methods-PurchaseStatus-nav"><a href="module-ElvWalletClient_Methods.html#.PurchaseStatus" class="method-link">PurchaseStatus</a></li><h4 class="methodGroupHeader">Stats</h4><li data-type="method" id="ElvWalletClient_Methods-ListingStats-nav"><a href="module-ElvWalletClient_Methods.html#.ListingStats" class="method-link">ListingStats</a></li><li data-type="method" id="ElvWalletClient_Methods-SalesStats-nav"><a href="module-ElvWalletClient_Methods.html#.SalesStats" class="method-link">SalesStats</a></li><h4 class="methodGroupHeader">User</h4><li data-type="method" id="ElvWalletClient_Methods-UserBalances-nav"><a href="module-ElvWalletClient_Methods.html#.UserBalances" class="method-link">UserBalances</a></li><li data-type="method" id="ElvWalletClient_Methods-UserProfile-nav"><a href="module-ElvWalletClient_Methods.html#.UserProfile" class="method-link">UserProfile</a></li></ul></li></ul>
      </div>
    </nav>

    <div class="main">
      <div class="header"></div>
      <div class="main-content">
        
        <h1 class="page-title">
          index.js
        </h1>
        

        
      

<a class="button" href="index.html">Back</a>
<div class="source-container">
  <pre class="prettyprint source linenums"><code>const EVENTS = require("./Events");

const UUID = () => {
  return "XXXXXXXX".replace(/[X]/g, () => {
    const r = Math.floor(Math.random() * 16);
    return r.toString(16);
  });
};


// https://stackoverflow.com/questions/4068373/center-a-popup-window-on-screen
const Popup = ({url, title, w, h}) => {
  // Fixes dual-screen position
  const dualScreenLeft = window.screenLeft || window.screenX;
  const dualScreenTop = window.screenTop || window.screenY;

  const width = window.innerWidth || document.documentElement.clientWidth || screen.width;
  const height = window.innerHeight || document.documentElement.clientHeight || screen.height;

  const systemZoom = width / window.screen.availWidth;
  const left = (width - w) / 2 / systemZoom + dualScreenLeft;
  const top = (height - h) / 2 / systemZoom + dualScreenTop;
  const newWindow = window.open(url, title,
    `
      scrollbars=yes,
      width=${w / systemZoom},
      height=${h / systemZoom},
      top=${top},
      left=${left}
    `
  );

  if(window.focus) newWindow.focus();

  return newWindow;
};

let __id = 0;
class Id {
  static next(){
    __id++;
    return __id;
  }
}

const SandboxPermissions = () => {
  return [
    "allow-downloads",
    "allow-scripts",
    "allow-forms",
    "allow-modals",
    "allow-pointer-lock",
    "allow-orientation-lock",
    "allow-popups",
    "allow-popups-to-escape-sandbox",
    "allow-presentation",
    "allow-same-origin",
    "allow-downloads-without-user-activation",
    "allow-storage-access-by-user-activation"
  ].join(" ");
};

const LOG_LEVELS = {
  DEBUG: 0,
  WARN: 1,
  ERROR: 2
};

/**
 * This page contains documentation for client setup, navigation and other management.
 &lt;br />&lt;br />
 * &lt;a href="./module-ElvWalletClient_Methods.html">For details on retrieving information from and performing actions in the wallet, see the wallet client methods page.&lt;/a>
 */
class ElvWalletClient {
  Throw(error) {
    throw new Error(`Eluvio Media Wallet Client | ${error}`);
  }

  Log({message, level=this.LOG_LEVELS.WARN}) {
    if(level &lt; this.logLevel) { return; }

    if(typeof message === "string") {
      message = `Eluvio Media Wallet Client | ${message}`;
    }

    switch(level) {
      case this.LOG_LEVELS.DEBUG:
        // eslint-disable-next-line no-console
        console.log(message);
        return;
      case this.LOG_LEVELS.WARN:
        // eslint-disable-next-line no-console
        console.warn(message);
        return;
      case this.LOG_LEVELS.ERROR:
        // eslint-disable-next-line no-console
        console.error(message);
        return;
    }
  }

  Destroy() {
    window.removeEventListener("message", this.EventHandler);

    if(this.Close) {
      this.Close();
    }

    if(this.target.close) {
      this.target.close();
    }
  }

  /**
   * This constructor should not be used. Please use &lt;a href="#.InitializePopup">InitializeFrame&lt;/a> or &lt;a href="#.InitializePopup">InitializePopup&lt;/a> instead.
   *
&lt;pre>&lt;code>
import { ElvWalletClient } from "@eluvio/elv-wallet-client";

// Initialize in iframe at target element
const walletClient = await ElvWalletClient.InitializeFrame({
 requestor: "My App",
 walletAppUrl: "https://wallet.contentfabric.io",
 target: document.getElementById("#wallet-target")
});

// Or initialize in a popup
const walletClient = await ElvWalletClient.InitializePopup({
 requestor: "My App",
 walletAppUrl: "https://wallet.contentfabric.io",
});
&lt;/code>&lt;/pre>
   * @constructor
   */
  constructor({
    appUUID,
    requestor,
    walletAppUrl="http://wallet.contentfabric.io",
    parentAppUrl,
    target,
    Close,
    timeout=300
  }) {
    if(!walletAppUrl) {
      this.Throw("walletAppUrl not specified");
    }

    if(!target) {
      this.Throw("target not specified");
    }

    this.appUUID = appUUID;
    this.requestor = requestor;
    this.walletAppUrl = walletAppUrl;
    this.parentAppUrl = parentAppUrl;
    this.target = target;
    this.Close = Close;
    this.timeout = timeout;
    this.LOG_LEVELS = LOG_LEVELS;
    this.logLevel = this.LOG_LEVELS.WARN;
    this.EVENTS = EVENTS;

    this.eventListeners = {};
    Object.keys(EVENTS).forEach(key => this.eventListeners[key] = []);

    this.EventHandler = this.EventHandler.bind(this);

    window.addEventListener("message", this.EventHandler);

    // Ensure client is destroyed when target window closes
    this.AddEventListener(this.EVENTS.CLOSE, () => this.Destroy());
  }

  EventHandler(event) {
    const message = event.data;

    if(
      message.type !== "ElvMediaWalletEvent" ||
      message.appUUID !== this.appUUID ||
      !EVENTS[message.event]
    ) {
      return;
    }

    const listeners = message.event === EVENTS.ALL ?
      this.eventListeners[EVENTS.ALL] :
      [...this.eventListeners[message.event], ...this.eventListeners[EVENTS.ALL]];

    listeners.forEach(async Listener => {
      try {
        await Listener(message);
      } catch(error) {
        this.Log({
          message: `${message.event} listener error:`,
          level: this.LOG_LEVELS.WARN
        });
        this.Log({
          message: error,
          level: this.LOG_LEVELS.WARN
        });
      }
    });
  }


  /**
   * Event keys that can be registered in AddEventListener.
   *
   * Available options: LOADED, LOG_IN, LOG_OUT, ROUTE_CHANGE, CLOSE, ALL
   *
   * Also accessible as a property via `walletClient.EVENTS`
   *
   * @methodGroup Events
   */
  Events() {
    return this.EVENTS;
  }

  /**
   * Add an event listener for the specified event
   *
   * Example:
   *
   * `walletClient.AddEventListener(walletClient.EVENTS.LOG_IN, HandleLogin);`
   *
   * @methodGroup Events
   * @param {string} event - An event key from &lt;a href="#Events">Events&lt;/a>
   * @param {function} Listener - An event listener
   */
  AddEventListener(event, Listener) {
    if(!EVENTS[event]) { this.Throw(`AddEventListener: Invalid event ${event}`); }

    if(typeof Listener !== "function") { this.Throw("AddEventListener: Listener is not a function"); }

    this.eventListeners[event].push(Listener);
  }

  /**
   * Remove the specified event listener
   *
   * @methodGroup Events
   * @param {string} event - An event key from &lt;a href="#Events">Events&lt;/a>
   * @param {function} Listener - The listener to remove
   */
  RemoveEventListener(event, Listener) {
    if(!EVENTS[event]) { this.Throw(`RemoveEventListener: Invalid event ${event}`); }
    if(typeof Listener !== "function") { this.Throw("RemoveEventListener: Listener is not a function"); }

    this.eventListeners[event] = this.eventListeners[event].filter(f => f !== Listener);
  }


  /**
   * Request the wallet app navigate to the specified page.
   *
   * When specifying a marketplace, you must provide either:
   &lt;pre>
   - tenantSlug and marketplaceSlug - Slugs for the tenant and marketplace
   - marketplaceHash - Version hash of a marketplace
   - marketplaceId - Object ID of a marketplace
   &lt;/pre>
   * Currently supported pages:
   &lt;pre>
   - 'login' - The login page
   - 'wallet' - The user's global wallet
   - 'items' - List of items in the user's wallet
   - 'item' - A specific item in the user's wallet
     -- Required param: `contractAddress` or `contractId`
     -- Required param: `tokenId`
   - 'profile' - The user's profile
   - 'marketplaces'
   - 'marketplace':
     -- Required param: marketplace parameters
   - 'marketplaceItem`
     -- Required params: `sku`, marketplace parameters
   - 'marketplaceWallet' - The user's collection for the specified marketplace
     -- Required params: marketplace parameters
   - `drop`
     -- Required params: `tenantSlug`, `eventSlug`, `dropId`, marketplace parameters
   - `listings`
   - `marketplaceListings`
     -- Required params: marketplace parameters
   &lt;/pre>

   * @methodGroup Navigation
   * @namedParams
   * @param {string=} page - A named app path
   * @param {Object=} params - URL parameters for the specified path, e.g. { tokenId: &lt;token-id> } for an 'item' page.
   * @param {string=} path - An absolute app path
   * @param {boolean=} loginRequired - If login was specified, this parameter will control whether the login prompt is dismissible
   * @param {Array&lt;string>=} marketplaceFilters - A list of filters to limit items shown in the marketplace store page
   *
   * @returns {string} - Returns the actual route to which the app has navigated
   */
  async Navigate({page, path, loginRequired, params, marketplaceFilters=[]}) {
    return this.SendMessage({
      action: "navigate",
      params: {
        page,
        path,
        params,
        loginRequired,
        marketplaceFilters
      }
    });
  }

  /**
   * Retrieve the current location path of the wallet app
   *
   * @methodGroup Navigation
   * @returns {string} - The current path of the wallet app
   */
  async CurrentPath() {
    return this.SendMessage({
      action: "currentPath"
    });
  }


  /**
   * Request the navigation header and footer to be shown or hidden in the wallet
   *
   * @methodGroup Navigation
   * @namedParams
   * @param {boolean=} enabled=true - True to show navigation, false to hide it
   */
  async ToggleNavigation(enabled=true) {
    return this.SendMessage({
      action: "toggleNavigation",
      params: {
        enabled
      },
      noResponse: true
    });
  }

  /**
   * Set whether the wallet should be displayed in dark mode
   *
   * @methodGroup Navigation
   * @namedParams
   * @param {boolean=} enabled=true - True to enable dark mode, false to disable
   */
  async ToggleDarkMode(enabled=true) {
    return this.SendMessage({
      action: "toggleDarkMode",
      params: {
        enabled
      },
      noResponse: true
    });
  }

  /**
   * Request the wallet enter/exit 'side panel' mode, where certain elements are hidden
   *
   * @methodGroup Navigation
   * @namedParams
   * @param {boolean=} enabled=true - Whether side panel mode should be enabled
   */
  async ToggleSidePanelMode(enabled=true) {
    return this.SendMessage({
      action: "toggleSidePanelMode",
      params: {
        enabled
      },
      noResponse: true
    });
  }

  /**
   * Sign the user in to the wallet app. Authorization can be provided in three ways:
   &lt;ul>
    &lt;li>- ID token from an OAuth flow&lt;/li>
    &lt;li>- Eluvio authorization token previously retrieved from exchanging an ID token&lt;/li>
    &lt;li>- Private key of the user&lt;/li>
   &lt;br/>
   *
   * NOTE: This is only to be used if authorization is performed outside of the wallet app. To direct the
   * wallet application to the login page, use the &lt;a href="#Navigate">Navigate&lt;/a> method
   *
   * @methodGroup Authorization
   * @namedParams
   * @param {string} name - The name of the user
   * @param {string} email - The email address of the user
   * @param {string=} idToken - An OAuth ID token to authenticate with
   * @param {string=} authToken - An Eluvio authorization token
   * @param {string=} privateKey - The private key of the user
   */
  async SignIn({name, email, idToken, authToken, privateKey}) {
    return this.SendMessage({
      action: "login",
      params: {
        idToken,
        authToken,
        privateKey,
        user: {
          name,
          email
        }
      }
    });
  }

  /**
   * Sign the current user out
   *
   * @methodGroup Authorization
   */
  async SignOut() {
    return this.SendMessage({
      action: "logout",
      params: {}
    });
  }

  /**
   * Initialize the media wallet in a new window.
   *
   * Calling client.Destroy() will close the popup.
   *
   * @methodGroup Constructor
   * @namedParams
   * @param {string} requestor - The name of your application. This field is used in permission prompts, e.g.
   &lt;br />
   &lt;br />
   `&lt;requestor> is requesting to perform &lt;action>`
   * @param {string=} walletAppUrl=http://wallet.contentfabric.io - The URL of the Eluvio Media Wallet app
   * @param {string=} parentAppUrl - The URL of your app. The wallet may need to re-open in a different context (e.g. Metamask browser), and this URL will be used instead, if specified.
   * @param {string=} tenantSlug - Specify the URL slug of your tenant. Required if specifying marketplaceSlug
   * @param {string=} marketplaceSlug - Specify the URL slug of your marketplace
   * @param {string=} marketplaceHash - Specify a specific version of a your marketplace. Not necessary if marketplaceSlug is specified
   * @param {boolean=} requireLogin=false - If specified, users will be required to log in before accessing any page in the app
   * @param {boolean=} loginOnly=false - If specified, only the login flow will be shown. Be sure to register an event listener for the `LOG_IN` event. `client.Destroy()` can be used to close the popup after login. Note that once this mode is activated, it cannot be deactivated - you must re-initialize the popup/frame.
   * @param {boolean=} captureLogin=false - If specified, the parent frame will be responsible for handling login requests. When the user attempts to log in, the LOG_IN_REQUESTED event will be fired.
   * @param {boolean=} darkMode=false - Specify whether the app should be in dark mode
   *
   * @returns {Promise&lt;ElvWalletClient>} - The ElvWalletClient initialized to communicate with the media wallet app in the new window.
   */
  static async InitializePopup({
    requestor,
    walletAppUrl="http://wallet.contentfabric.io",
    parentAppUrl,
    tenantSlug,
    marketplaceSlug,
    marketplaceId,
    marketplaceHash,
    requireLogin=false,
    loginOnly=false,
    captureLogin=false,
    darkMode=false
  }) {
    const appUUID = UUID();

    walletAppUrl = new URL(walletAppUrl);

    walletAppUrl.searchParams.set("appUUID", appUUID);

    if(marketplaceSlug) {
      walletAppUrl.searchParams.set("mid", `${tenantSlug}/${marketplaceSlug}`);
    } else if(marketplaceId || marketplaceHash) {
      walletAppUrl.searchParams.set("mid", marketplaceHash || marketplaceId);
    }

    if(walletAppUrl.searchParams.has("mid") &amp;&amp; !walletAppUrl.hash) {
      walletAppUrl.hash = `#/marketplaces/redirect/${tenantSlug}/${marketplaceSlug}/store`;
    }

    if(requireLogin){
      walletAppUrl.searchParams.set("rl", "");
    }

    if(loginOnly) {
      walletAppUrl.searchParams.set("lo", "");
    }

    if(captureLogin) {
      walletAppUrl.searchParams.set("cl", "");
    }

    if(darkMode) {
      walletAppUrl.searchParams.set("dk", "");
    }

    if(parentAppUrl) {
      walletAppUrl.searchParams.set("app", (parentAppUrl));
    }

    const target = Popup({url: walletAppUrl.toString(), title: "Eluvio Media Wallet", w: 400, h: 700});

    const client = new ElvWalletClient({
      appUUID,
      requestor,
      walletAppUrl: walletAppUrl.toString(),
      parentAppUrl,
      target,
      Close: () => target.close()
    });

    // Ensure app is initialized
    await client.AwaitMessage("init");

    // Watch for popup to be closed
    let popupInterval = setInterval(() => {
      if(target.closed) {
        clearInterval(popupInterval);
        client.EventHandler({data: { type: "ElvMediaWalletEvent", event: EVENTS.CLOSE }});
      }
    }, 1000);

    return client;
  }

  /**
   * Initialize the media wallet in a new iframe. The target can be an existing iframe or an element in which to create the iframe,
   * and the target can be passed in either as an element directly, or by element ID.
   *
   * @methodGroup Constructor
   *
   * @namedParams
   * @param {string} requestor - The name of your application. This field is used in permission prompts, e.g.
   &lt;br />
   &lt;br />
   `&lt;requestor> is requesting to perform &lt;action>`
   * @param {string=} walletAppUrl=http://wallet.contentfabric.io - The URL of the Eluvio Media Wallet app
   * @param {string=} parentAppUrl - The URL of your app. The wallet may need to re-open in a different context (e.g. Metamask browser), and this URL will be used instead, if specified.
   * @param {Object | string} target - An HTML element or the ID of an element
   * @param {string=} tenantSlug - Specify the URL slug of your tenant. Required if specifying marketplace slug
   * @param {string=} marketplaceSlug - Specify the URL slug of your marketplace
   * @param {string=} marketplaceHash - Specify a specific version of a your marketplace. Not necessary if marketplaceSlug is specified
   * @param {boolean=} requireLogin=false - If specified, users will be required to log in before accessing any page in the app
   * @param {boolean=} loginOnly=false - If specified, only the login flow will be shown. Be sure to register an event listener for the `LOG_IN` event. Note that once this mode is activated, it cannot be deactivated - you must re-initialize the popup/frame.
   * @param {boolean=} captureLogin - If specified, the parent frame will be responsible for handling login requests. When the user attempts to log in, the LOG_IN_REQUESTED event will be fired.
   * @param {boolean=} darkMode=false - Specify whether the app should be in dark mode
   *
   * @returns {Promise&lt;ElvWalletClient>} - The ElvWalletClient initialized to communicate with the media wallet app in the new iframe.
   */
  static async InitializeFrame({
    requestor,
    walletAppUrl="http://wallet.contentfabric.io",
    parentAppUrl,
    target,
    tenantSlug,
    marketplaceSlug,
    marketplaceId,
    marketplaceHash,
    requireLogin=false,
    loginOnly=false,
    captureLogin=false,
    darkMode=false
  }) {
    const appUUID = UUID();

    if(typeof target === "string") {
      const targetElement = document.getElementById(target);

      if(!targetElement) {
        throw Error(`Eluvio Media Wallet Client: Unable to find element with target ID ${target}`);
      }

      target = targetElement;
    }

    if((target.tagName || target.nodeName).toLowerCase() !== "iframe") {
      let parent = target;
      parent.innerHTML = "";

      target = document.createElement("iframe");
      parent.appendChild(target);
    }

    target.classList.add("-elv-media-wallet-frame");
    target.sandbox = SandboxPermissions();
    target.setAttribute("allowFullScreen", "");
    target.allow = "encrypted-media *; autoplay; fullscreen; clipboard-read; clipboard-write";
    target.title = "Eluvio Media Wallet";

    walletAppUrl = new URL(walletAppUrl);

    walletAppUrl.searchParams.set("appUUID", appUUID);

    if(marketplaceSlug) {
      walletAppUrl.searchParams.set("mid", `${tenantSlug}/${marketplaceSlug}`);
    } else if(marketplaceId || marketplaceHash) {
      walletAppUrl.searchParams.set("mid", marketplaceHash || marketplaceId);
    }

    if(walletAppUrl.searchParams.has("mid") &amp;&amp; !walletAppUrl.hash) {
      walletAppUrl.hash = `#/marketplaces/redirect/${tenantSlug}/${marketplaceSlug}/store`;
    }

    if(requireLogin){
      walletAppUrl.searchParams.set("rl", "");
    }

    if(loginOnly) {
      walletAppUrl.searchParams.set("lo", "");
    }

    if(captureLogin) {
      walletAppUrl.searchParams.set("cl", "");
    }

    if(darkMode) {
      walletAppUrl.searchParams.set("dk", "");
    }

    if(parentAppUrl) {
      walletAppUrl.searchParams.set("app", btoa(parentAppUrl));
    }

    const client = new ElvWalletClient({
      appUUID,
      requestor,
      walletAppUrl: walletAppUrl.toString(),
      parentAppUrl,
      target: target.contentWindow,
      Close: () => target &amp;&amp; target.parentNode &amp;&amp; target.parentNode.removeChild(target)
    });

    // Ensure app is initialized
    target.src = walletAppUrl.toString();
    await client.AwaitMessage("init");

    return client;
  }

  async SendMessage({action, params, noResponse=false}) {
    const requestId = `action-${Id.next()}`;

    this.target.postMessage({
      type: "ElvMediaWalletClientRequest",
      requestor: this.requestor,
      requestId,
      action,
      params
    }, this.walletAppUrl);

    if(noResponse) { return; }

    return (await this.AwaitMessage(requestId));
  }

  async AwaitMessage(requestId) {
    const timeout = this.timeout;
    return await new Promise((resolve, reject) => {
      let methodListener;

      // Initialize or reset timeout
      let timeoutId;
      const touchTimeout = () => {
        if(timeoutId) {
          clearTimeout(timeoutId);
        }

        if(timeout > 0) {
          timeoutId = setTimeout(() => {
            if(typeof window !== "undefined") {
              window.removeEventListener("message", methodListener);
            }

            reject(`Request ${requestId} timed out`);
          }, timeout * 1000);
        }
      };

      methodListener = async (event) => {
        try {
          const message = event.data;

          if(message.type !== "ElvMediaWalletResponse" || message.requestId !== requestId) {
            return;
          }

          clearTimeout(timeoutId);

          window.removeEventListener("message", methodListener);

          if(message.error) {
            reject(message.error);
          } else {
            resolve(message.response);
          }
        } catch(error){
          clearTimeout(timeoutId);

          window.removeEventListener("message", methodListener);

          reject(error);
        }
      };

      // Start the timeout
      touchTimeout();

      window.addEventListener("message", methodListener);
    });
  }
}

/**
 * `client.EVENTS` contains event keys for the AddEventListener and RemoveEventListener methods
 *
 * - `client.EVENTS.LOADED` - Wallet app has finished loading and authentication is settled. If a user is currently logged in, a `LOG_IN` event will have preceded this event.
 * - `client.EVENTS.LOG_IN` - User has logged in. Event data contains user address.
 * - `client.EVENTS.LOG_OUT` - User has logged out. Event data contains user address.
 * - `client.EVENTS.CLOSE` - Target window or frame has been closed or has otherwise unloaded the wallet app.
 * - `client.EVENTS.ROUTE_CHANGE` - The wallet app's current route has changed. Event data contains the current route of the app.
 * - `client.EVENTS.ALL` - Any of the above events has occurred.
 */
ElvWalletClient.EVENTS = EVENTS;
ElvWalletClient.LOG_LEVELS = LOG_LEVELS;

Object.assign(ElvWalletClient.prototype, require("./ClientMethods"));

exports.ElvWalletClient = ElvWalletClient;
</code></pre>
</div>

    



        <footer class="footer">
          Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.10</a>
        </footer>
      </div>
    </div>
  </div>

  <script>
    // Format and add line numbers to code
    prettyPrint();
  </script>

  <script type="text/javascript" src="scripts/utils.js"></script>

  </body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Apple Pay QR Handoff Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script crossorigin src="https://applepay.cdn-apple.com/jsapi/1.latest/apple-pay-sdk.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; margin: 2em; }
    #result {
      margin-top: 1.5em;
      font-size: 1.1em;
    }
    apple-pay-button {
      --apple-pay-button-width: 300px;
      --apple-pay-button-height: 60px;
      --apple-pay-button-border-radius: 12px;
      --apple-pay-button-padding: 0px 0px;
      --apple-pay-button-box-sizing: border-box;
      display: none;
    }
  </style>
</head>
<body>
  <h1>Apple Pay Demo</h1>
  <p>
    Click the button below to try the Apple Pay Web-to-iPhone handoff.<br>
  </p>
  <p>
    On Chrome, Edge, or Firefox with iOS 18+, you should see a QR code.<br>
    On Safari, it will try to use the native integration.<br>
  </p>
  <p>
    Scan the code with your iPhone camera to continue payment there.
  </p>
  <apple-pay-button id="apple-pay-button" buttonstyle="black" type="plain" locale="en-US"></apple-pay-button>
  <div id="result"></div>
  <script>
    const applePayButton = document.getElementById('apple-pay-button');
    const resultDiv = document.getElementById('result');

    // Show the button only if Apple Pay is available
    if (window.ApplePaySession) {
      applePayButton.style.display = 'inline-block';
    } else {
      resultDiv.textContent = "Apple Pay is not supported in this browser.";
    }

    applePayButton.addEventListener('click', () => {
      if (!window.ApplePaySession) {
        resultDiv.textContent = "Apple Pay is not supported in this browser.";
        return;
      }

      const paymentRequest = {
        countryCode: 'US',
        currencyCode: 'USD',
        supportedNetworks: ['visa', 'masterCard', 'amex'],
        merchantCapabilities: [ "supports3DS", "supportsCredit", "supportsDebit" ],
        total: { label: 'Demo (Card will not be charged)', amount: '2.99' },
        merchantIdentifier: 'merchant.ap.eluv.io'
      };

      let session;
      try {
        session = new ApplePaySession(4, paymentRequest);
      } catch(e) {
        resultDiv.textContent = "Apple Pay is not available on this platform.";
        return;
      }

      session.onvalidatemerchant = event => {
        console.log("onvalidatemerchant", JSON.stringify(event));
        fetch('https://host-154-14-211-102.contentfabric.io/as/otp/webhook/applepay', {
          method: 'POST',
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ validationURL: event.validationURL })
        })
        .then(res => {
          if (!res.ok) throw new Error("Merchant validation failed");
          return res.json();
        })
        .then(merchantSession => {
          session.completeMerchantValidation(merchantSession);
        })
        .catch(err => {
          resultDiv.textContent = "Merchant validation failed: " + err;
          session.abort();
        });
      };

      session.onpaymentauthorized = event => {
        const params = new URLSearchParams(window.location.search);
        const doPay = params.has("pay");

        const generateUserAddress = () => {
          const chars = "0123456789abcdef";
          let result = "";
          for(let i = 0; i < 40; i++) {
            result += chars[Math.floor(Math.random() * 16)];
          }
          return "0x" + result;
        };

        if(!doPay) {
          console.log("onPaymentAuthorized: simulating payment success");
          setTimeout(() => {
            session.completePayment(ApplePaySession.STATUS_SUCCESS);
            resultDiv.textContent = "Payment successful! (Simulated)";
          }, 1000);
        } else {
          console.log("onPaymentAuthorized: processing payment with server");
          fetch("https://host-154-14-211-102.contentfabric.io/as/otp/webhook/applepay/process", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
              amount: 299,
              currency: "USD",
              user_addr: generateUserAddress(),
              payment: event.payment,
              mode: "develop",
            })
          })
          .then(res => res.json())
          .then(result => {
            if(result.success) {
              session.completePayment(ApplePaySession.STATUS_SUCCESS);
            } else {
              session.completePayment(ApplePaySession.STATUS_FAILURE);
            }
          });
        }
      };

      session.oncancel = () => {
        resultDiv.textContent = "Payment cancelled or not completed.";
      };

      session.begin();
    });
  </script>
</body>
</html>
